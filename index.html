<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" content="text/html" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MP3 キーチェンジャー</title>
<style>
  body{font-family:sans-serif;margin:0;padding:20px 20px 70px;}
  #playlist{margin-top:10px;}
  .track{cursor:pointer;margin-bottom:5px;}
  .track.selected{font-weight:bold;color:blue;}
  .controls,.sliders{margin-top:20px;}
  input[type=range]{width:100%;}
  .inline-label{display:flex;align-items:center;gap:8px;}
  .key-control-buttons{display:flex;gap:8px;align-items:center;}
  .time-display{margin-top:10px;font-size:14px;color:#333;}
  .loading-overlay{position:fixed;inset:0;background:rgba(255,255,255,.8);
    display:none;justify-content:center;align-items:center;font-size:20px;font-weight:bold;z-index:999;}
  footer{position:fixed;inset-block-end:0;inset-inline:0;background:#f2f2f2;
    border-top:1px solid #ccc;padding:10px 20px;font-size:14px;color:#666;
    display:flex;justify-content:space-between;align-items:center;}
  @media(max-width:600px){
    body{padding:10px 10px 70px;}
    button{font-size:16px;padding:10px;width:100%;margin-bottom:10px;}
    .inline-label{flex-direction:column;align-items:flex-start;}
  }
</style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">読み込み中...</div>

  <!--
    ★ Media Session API を使えばロック画面／イヤホンからの
       再生・一時停止・シーク操作も可能です（iOS 15+ Safari/Chrome）。
  -->

  <input type="file" id="fileInput" multiple accept="audio/*">
  <div id="playlist"></div>

  <div class="controls">
    <button onclick="playAudio()">再生</button>
    <button onclick="pauseAudio()">一時停止</button>
    <button onclick="stopAudio()">停止</button>
    <button onclick="nextTrack()">次の曲へ</button>
    <button onclick="toggleShuffle()">シャッフル: <span id="shuffleState">OFF</span></button>
  </div>

  <div class="sliders">
    <label class="inline-label">キー変更（半音）:
      <div class="key-control-buttons">
        <button onclick="adjustPitch(-1)">−</button>
        <input type="range" id="pitchSlider" min="-12" max="12" step="1" value="0">
        <button onclick="adjustPitch(1)">＋</button>
        <span id="pitchValue">0</span>
      </div>
    </label>

    <label>再生位置:
      <input type="range" id="seekSlider" min="0" max="1" step="0.01" value="0">
    </label>

    <div class="time-display" id="timeDisplay">--:-- / --:--</div>
  </div>

  <!-- バックグラウンド再生用 audio -->
  <audio id="htmlAudio" preload="auto" style="display:none"></audio>

  <footer>
    <span id="metaInfo">プレイリスト: 0 曲</span>
    <span id="playStatus">未再生</span>
    <span class="version">v1.4.2</span>
  </footer>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <script>
/* ========== 変数 & DOM ========== */
const htmlAudio   = document.getElementById('htmlAudio');
const playStatus  = document.getElementById('playStatus');
const timeDisplay = document.getElementById('timeDisplay');
const seekSlider  = document.getElementById('seekSlider');
const loadingLay  = document.getElementById('loadingOverlay');
const metaInfo    = document.getElementById('metaInfo');
const fileInput   = document.getElementById('fileInput');

let playlist     = [];
let currentIndex = -1;
let shuffle      = false;
let updateTimer  = null;

/* ========== Tone.js ノード構築 ========== */
const mediaSrc   = Tone.context.createMediaElementSource(htmlAudio);
const pitchShift = new Tone.PitchShift({ pitch: 0 }).toDestination();
mediaSrc.connect(pitchShift);

/* ========== 共通 ========== */
const showLoading = on => loadingLay.style.display = on ? 'flex' : 'none';
const fmt = s=>isNaN(s)?'--:--':`${String(Math.floor(s/60)).padStart(2,'0')}:${String(Math.floor(s%60)).padStart(2,'0')}`;

/* ========== ファイル追加（上書き→追加に変更） ========== */
fileInput.addEventListener('change', e=>{
  const added = Array.from(e.target.files);
  added.forEach(f=>{
    if(!playlist.some(p=>p.name===f.name)) playlist.push(f);  // 重複はスキップ
  });
  fileInput.value='';      // 同じファイル連続選択可
  renderPlaylist();
});
function renderPlaylist(){
  const list=document.getElementById('playlist');
  list.innerHTML='';
  playlist.forEach((f,i)=>{
    const div=document.createElement('div');
    div.textContent=f.name;
    div.className='track'+(i===currentIndex?' selected':'');
    div.onclick=()=>loadAndPlay(i);
    list.appendChild(div);
  });
  metaInfo.textContent=`プレイリスト: ${playlist.length} 曲`;
}

/* ========== ピッチ ========== */
document.getElementById('pitchSlider').addEventListener('input',e=>{
  const v=parseInt(e.target.value);
  pitchShift.pitch=v;
  document.getElementById('pitchValue').textContent=v;
});
function adjustPitch(d){
  const s=document.getElementById('pitchSlider');
  s.value=Math.max(-12,Math.min(12,parseInt(s.value)+d));
  s.dispatchEvent(new Event('input'));
}

/* ========== 再生制御 ========== */
async function loadAndPlay(idx){
  if(!playlist.length)return;
  showLoading(true);stopAudio(false);
  currentIndex=idx;renderPlaylist();

  htmlAudio.src=URL.createObjectURL(playlist[idx]);
  await Tone.start();if(Tone.context.state==='suspended')await Tone.context.resume();
  await htmlAudio.play();updateSeekBar();

  playStatus.textContent='再生中';playStatus.style.color='green';
  showLoading(false);
}
function playAudio(){
  if(!htmlAudio.src)return;
  Tone.start().then(async()=>{
    if(Tone.context.state==='suspended')await Tone.context.resume();
    htmlAudio.play();
    playStatus.textContent='再生中';playStatus.style.color='green';
  });
}
function pauseAudio(){
  if(htmlAudio.paused)return;
  htmlAudio.pause();
  playStatus.textContent='一時停止';playStatus.style.color='orange';
}
function stopAudio(reset=true){
  htmlAudio.pause();htmlAudio.currentTime=0;clearInterval(updateTimer);
  seekSlider.value=0;timeDisplay.textContent='--:-- / --:--';
  if(reset){playStatus.textContent='停止';playStatus.style.color='gray';}
}
function nextTrack(){
  if(!playlist.length)return;
  const n=shuffle
    ?(playlist.length===1?currentIndex:(()=>{let r;do{r=Math.floor(Math.random()*playlist.length);}while(r===currentIndex);return r;})())
    :(currentIndex+1)%playlist.length;
  loadAndPlay(n);
}
function toggleShuffle(){
  shuffle=!shuffle;
  document.getElementById('shuffleState').textContent=shuffle?'ON':'OFF';
}
htmlAudio.addEventListener('ended',()=>nextTrack());

/* ========== シークバー ========== */
seekSlider.addEventListener('input',e=>{
  if(!htmlAudio.duration)return;
  htmlAudio.currentTime=parseFloat(e.target.value);
});
function updateSeekBar(){
  clearInterval(updateTimer);
  if(!htmlAudio.duration)return;
  const dur=htmlAudio.duration;seekSlider.max=dur;
  const refresh=()=>{
    seekSlider.value=htmlAudio.currentTime;
    timeDisplay.textContent=`${fmt(htmlAudio.currentTime)} / ${fmt(dur)}`;
  };
  refresh();updateTimer=setInterval(refresh,500);
}
  </script>
</body>
</html>
