<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MP3 キーチェンジャー</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h1 { font-size: 24px; }
    #playlist { margin-top: 10px; }
    .track { cursor: pointer; margin-bottom: 5px; }
    .track.selected { font-weight: bold; color: blue; }
    .controls, .sliders { margin-top: 20px; }
    input[type=range] { width: 100%; }
    .inline-label { display: flex; align-items: center; gap: 8px; }

    @media (max-width: 600px) {
      body { padding: 10px; font-size: 16px; }
      h1 { font-size: 20px; }
      button { font-size: 16px; padding: 10px; width: 100%; margin-bottom: 10px; }
      .inline-label { flex-direction: column; align-items: flex-start; }
      input[type=range] { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>クライアントサイド MP3 キーチェンジャー</h1>
  <input type="file" id="fileInput" multiple accept="audio/mp3">
  <div id="playlist"></div>
  <div class="controls">
    <button onclick="playAudio()">再生</button>
    <button onclick="pauseAudio()">一時停止</button>
    <button onclick="stopAudio()">停止</button>
  </div>
  <div class="sliders">
    <label>音量調整:
      <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
    </label>
    <label class="inline-label">キー変更（半音）:
      <input type="range" id="pitchSlider" min="-12" max="12" step="1" value="0">
      <span id="pitchValue">0</span>
    </label>
    <label>再生位置:
      <input type="range" id="seekSlider" min="0" max="1" step="0.01" value="0">
    </label>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.39/Tone.js"></script>
  <script>
    let playlist = [];
    let currentIndex = -1;
    let player = null;
    let pitchShift = null;

    document.getElementById('fileInput').addEventListener('change', (e) => {
      playlist = Array.from(e.target.files);
      renderPlaylist();
    });

    document.getElementById('volumeSlider').addEventListener('input', e => {
      if (player) player.volume.value = Tone.gainToDb(parseFloat(e.target.value));
    });

    document.getElementById('pitchSlider').addEventListener('input', e => {
      document.getElementById('pitchValue').textContent = e.target.value;
      if (pitchShift) pitchShift.pitch = parseInt(e.target.value);
    });

    document.getElementById('seekSlider').addEventListener('input', e => {
      if (player && player.buffer && player.buffer.duration) {
        const newTime = parseFloat(e.target.value) * player.buffer.duration;
        player.seek(newTime);
      }
    });

    function renderPlaylist() {
      const list = document.getElementById('playlist');
      list.innerHTML = '';
      playlist.forEach((file, index) => {
        const div = document.createElement('div');
        div.textContent = file.name;
        div.className = 'track' + (index === currentIndex ? ' selected' : '');
        div.onclick = () => loadAndPlay(index);
        list.appendChild(div);
      });
    }

    async function loadAndPlay(index) {
      currentIndex = index;
      renderPlaylist();

      if (player) {
        player.dispose();
        pitchShift.dispose();
      }

      const file = playlist[index];
      const arrayBuffer = await file.arrayBuffer();
      const audioBuffer = await Tone.context.decodeAudioData(arrayBuffer);

      const buffer = new Tone.ToneAudioBuffer(audioBuffer);
      pitchShift = new Tone.PitchShift({ pitch: parseInt(document.getElementById('pitchSlider').value) }).toDestination();
      player = new Tone.Player(buffer).connect(pitchShift);
      player.volume.value = Tone.gainToDb(parseFloat(document.getElementById('volumeSlider').value));

      Tone.loaded().then(() => {
        player.start();
        updateSeekBar();
      });
    }

    function playAudio() {
      if (player && !player.state || player.state === 'stopped') player.start();
    }

    function pauseAudio() {
      if (player && player.state === 'started') player.stop();
    }

    function stopAudio() {
      if (player) player.stop();
      document.getElementById('seekSlider').value = 0;
    }

    function updateSeekBar() {
      if (!player || !player.buffer || !player.buffer.duration) return;
      requestAnimationFrame(() => {
        if (player && player.buffer.duration) {
          const pos = player.toSeconds(player.now());
          const progress = pos / player.buffer.duration;
          document.getElementById('seekSlider').value = progress;
          updateSeekBar();
        }
      });
    }
  </script>
</body>
</html>